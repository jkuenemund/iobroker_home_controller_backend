<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Home Controller</title>

    <!-- Load ioBroker socket.io -->
    <script type="text/javascript" src="../../socket.io/socket.io.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f4f6f8;
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 100%;
            /* Full width */
            margin: 0 auto;
        }

        h1 {
            color: #333;
            font-size: 1.8em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: #fff;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .config-info {
            font-size: 0.9em;
            color: #666;
        }

        /* WebSocket Clients Section */
        .clients-section {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 20px;
        }

        .clients-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #0369a1;
            margin-bottom: 8px;
        }

        .clients-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .client-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: white;
            border: 1px solid #e0e7ff;
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 0.85em;
        }

        .client-badge .client-icon {
            font-size: 1.1em;
        }

        .client-badge .client-name {
            font-weight: 500;
            color: #333;
        }

        .client-badge .client-version {
            color: #888;
            font-size: 0.9em;
        }

        .client-badge .client-close {
            color: #999;
            cursor: pointer;
            font-size: 1em;
            padding: 2px;
            margin-left: 4px;
            transition: all 0.2s;
            border-radius: 50%;
        }

        .client-badge .client-close:hover {
            color: #ef4444;
            background: #fee2e2;
        }

        .no-clients {
            color: #64748b;
            font-style: italic;
        }

        /* Client Request Logs */
        .client-wrapper {
            width: 100%;
        }

        .client-logs-toggle {
            color: #6366f1;
            cursor: pointer;
            font-size: 0.85em;
            padding: 2px 6px;
            margin-left: 4px;
            transition: all 0.2s;
            border-radius: 4px;
            user-select: none;
        }

        .client-logs-toggle:hover {
            background: #eef2ff;
        }

        .client-logs-panel {
            display: none;
            margin-top: 8px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 8px;
            font-size: 0.8em;
            max-height: 200px;
            overflow-y: auto;
        }

        .client-logs-panel.visible {
            display: block;
        }

        .log-entry {
            display: flex;
            gap: 8px;
            padding: 4px 0;
            border-bottom: 1px solid #e2e8f0;
            font-family: 'Courier New', monospace;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-time {
            color: #64748b;
            min-width: 60px;
        }

        .log-type {
            color: #0ea5e9;
            font-weight: 500;
            min-width: 100px;
        }

        .log-id {
            color: #94a3b8;
        }

        .no-logs {
            color: #94a3b8;
            font-style: italic;
            text-align: center;
            padding: 8px;
        }

        /* Expandable Device Capabilities */
        .expand-icon {
            cursor: pointer;
            user-select: none;
            font-size: 1.2em;
            transition: transform 0.2s;
            display: inline-block;
        }

        .expand-icon.expanded {
            transform: rotate(90deg);
        }

        .capabilities-row {
            display: none;
            background: #f8fafc;
        }

        .capabilities-row.visible {
            display: table-row;
        }

        .capabilities-panel {
            padding: 16px;
            border-left: 3px solid #667eea;
        }

        .capability-item {
            display: grid;
            grid-template-columns: 100px 1fr 100px 180px;
            gap: 12px;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.9em;
            align-items: center;
        }

        .capability-item:last-child {
            border-bottom: none;
        }

        .capability-type {
            font-weight: 600;
            color: #4f46e5;
        }

        .capability-state {
            font-family: 'Courier New', monospace;
            color: #64748b;
            font-size: 0.85em;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .capability-value {
            font-weight: 500;
            color: #0f172a;
            background: #e2e8f0;
            padding: 2px 8px;
            border-radius: 4px;
            text-align: center;
            font-size: 0.85em;
        }

        .capability-value.active {
            background: #dcfce7;
            color: #166534;
        }

        .capability-props {
            color: #94a3b8;
            font-size: 0.85em;
        }

        .no-capabilities {
            color: #94a3b8;
            font-style: italic;
            padding: 12px;
            text-align: center;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-button {
            padding: 10px 20px;
            border: none;
            background: #e0e0e0;
            cursor: pointer;
            border-radius: 4px;
            font-weight: 600;
            color: #555;
            transition: all 0.2s;
        }

        .tab-button:hover {
            background: #d0d0d0;
        }

        .tab-button.active {
            background: #667eea;
            color: white;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 4px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        th,
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #444;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background-color: #f5f9ff;
        }

        .status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            color: white;
        }

        /* Add Button */
        .add-button {
            padding: 10px 20px;
            border: none;
            background: #10b981;
            cursor: pointer;
            border-radius: 4px;
            font-weight: 600;
            color: white;
            transition: all 0.2s;
            margin-left: auto;
        }

        .add-button:hover {
            background: #059669;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        .action-btn {
            padding: 8px 16px;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 0.9em;
        }

        .action-btn.export {
            background: #3b82f6;
            color: white;
        }

        .action-btn.export:hover {
            background: #2563eb;
        }

        .action-btn.import {
            background: #8b5cf6;
            color: white;
        }

        .action-btn.import:hover {
            background: #7c3aed;
        }

        .action-btn.add {
            background: #10b981;
            color: white;
        }

        .action-btn.add:hover {
            background: #059669;
        }

        /* Success message */
        .success-message {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 16px;
            display: none;
        }

        .success-message.visible {
            display: block;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 8px;
            padding: 24px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group textarea {
            font-family: monospace;
            min-height: 300px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .error-message {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #b91c1c;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 16px;
            display: none;
        }

        .error-message.visible {
            display: block;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #555;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header-controls">
            <h1><span style="font-size: 1.2em;">üëã</span> Home Controller</h1>
            <div class="config-info">
                Base Path: <code id="basePath"
                    style="background: #eee; padding: 2px 6px; border-radius: 4px;">Loading...</code>
                <span class="status" id="status" style="background: #999; margin-left: 10px;">Connecting...</span>
            </div>
        </div>

        <!-- WebSocket Clients Section -->
        <div class="clients-section">
            <div class="clients-header">
                üîå WebSocket Clients
            </div>
            <div class="clients-list" id="clientsList">
                <span class="no-clients">No clients connected</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('devices')">Devices</button>
            <button class="tab-button" onclick="switchTab('rooms')">Rooms</button>
            <div class="action-buttons">
                <button class="action-btn export" onclick="exportData()">‚¨áÔ∏è Export</button>
                <button class="action-btn import" onclick="document.getElementById('importFile').click()">‚¨ÜÔ∏è
                    Import</button>
                <button class="action-btn add" onclick="openAddDialog()">‚ûï Add</button>
            </div>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImportFile(event)">
        </div>

        <div class="table-container">
            <table id="deviceTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="2" style="text-align: center; color: #999;">Select a tab to load data</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add Modal -->
    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <h2 id="modalTitle">Add New Device</h2>
            <div class="error-message" id="errorMessage"></div>
            <div class="form-group">
                <label for="itemId">ID (unique identifier, e.g., kitchen_light)</label>
                <input type="text" id="itemId" placeholder="Enter unique ID...">
            </div>
            <div class="form-group">
                <label for="itemConfig">Configuration (JSON)</label>
                <textarea id="itemConfig"></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeAddDialog()">Cancel</button>
                <button class="btn btn-primary" onclick="saveNewItem()">Save</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize socket.io connection
        const socket = io.connect();
        const statusEl = document.getElementById('status');
        const basePathEl = document.getElementById('basePath');
        const tableBody = document.querySelector('#deviceTable tbody');

        let currentBasePath = '';
        let currentTab = 'devices';

        socket.on('connect', () => {
            console.log('Connected to ioBroker');
            statusEl.textContent = 'Connected';
            statusEl.style.background = '#10b981';

            // Fetch adapter config
            socket.emit('getObject', 'system.adapter.home_controller_backend.0', (err, obj) => {
                if (!err && obj && obj.native) {
                    currentBasePath = obj.native.basePath;
                    console.log('Adapter config loaded:', obj.native);
                    basePathEl.textContent = currentBasePath || 'Not set';

                    if (currentBasePath) {
                        loadData();
                    }

                    // Load connected clients
                    loadConnectedClients();

                    // Subscribe to client changes
                    socket.emit('subscribe', 'home_controller_backend.0.info.connectedClients');
                } else {
                    basePathEl.textContent = 'Error loading config';
                    console.error('Error loading adapter config:', err);
                }
            });
        });

        const columns = {
            devices: [
                { key: 'expand', label: '' },
                { key: 'id', label: 'ID' },
                { key: 'icon', label: 'Icon' },
                { key: 'name', label: 'Name' },
                { key: 'type', label: 'Type' },
                { key: 'room', label: 'Room' },
                { key: 'manufacturer', label: 'Manufacturer' },
                { key: 'description', label: 'Description' }
            ],
            rooms: [
                { key: 'id', label: 'ID' },
                { key: 'icon', label: 'Icon' },
                { key: 'name', label: 'Name' },
                { key: 'metrics', label: 'Metrics' },
                { key: 'details', label: 'Details' }
            ]
        };

        function switchTab(tabName) {
            currentTab = tabName;

            // Update UI
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase() === tabName) {
                    btn.classList.add('active');
                }
            });

            if (currentBasePath) {
                loadData();
            }
        }

        function loadData() {
            const targetPath = `${currentBasePath}.${currentTab}`;
            console.log('Loading data from:', targetPath);

            // Update Table Header
            const tableHead = document.querySelector('#deviceTable thead tr');
            tableHead.innerHTML = '';
            columns[currentTab].forEach(col => {
                const th = document.createElement('th');
                th.textContent = col.label;
                tableHead.appendChild(th);
            });

            tableBody.innerHTML = `<tr><td colspan="${columns[currentTab].length}" style="text-align: center; color: #666;">Loading ${currentTab}...</td></tr>`;

            socket.emit('getStates', targetPath + '.*', (err, states) => {
                if (err) {
                    console.error('Error fetching states:', err);
                    tableBody.innerHTML = `<tr><td colspan="${columns[currentTab].length}" style="color: red;">Error: ${err}</td></tr>`;
                    return;
                }

                console.log('States received:', states);
                tableBody.innerHTML = '';

                if (!states || Object.keys(states).length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="${columns[currentTab].length}" style="text-align: center;">No ${currentTab} found under ${targetPath}</td></tr>`;
                    return;
                }

                Object.keys(states).sort().forEach(id => {
                    // Show relative ID
                    const relativeId = id.startsWith(targetPath + '.') ? id.substring(targetPath.length + 1) : id;
                    const val = states[id] ? states[id].val : null;

                    let data = {};
                    try {
                        data = val ? JSON.parse(val) : {};
                    } catch (e) {
                        console.warn('Failed to parse JSON for', id, val);
                        data = { name: 'Invalid JSON' };
                    }

                    // Add ID to data object for easy access
                    data.id = relativeId;

                    const row = document.createElement('tr');
                    row.dataset.deviceId = relativeId;

                    columns[currentTab].forEach(col => {
                        const td = document.createElement('td');

                        if (col.key === 'expand' && currentTab === 'devices') {
                            // Add expand icon for devices
                            td.innerHTML = '<span class="expand-icon" onclick="toggleCapabilities(this)">‚ñ∂</span>';
                            td.style.width = '30px';
                            td.style.textAlign = 'center';
                        } else {
                            let cellValue = data[col.key] || '-';

                            // Special formatting
                            if (col.key === 'metrics' && Array.isArray(cellValue)) {
                                cellValue = cellValue.length + ' metrics';
                            }
                            if (col.key === 'icon') {
                                td.style.fontSize = '1.5em';
                                td.style.textAlign = 'center';
                            }
                            if (col.key === 'id') {
                                td.style.fontFamily = 'monospace';
                            }

                            td.textContent = cellValue;
                        }

                        row.appendChild(td);
                    });

                    tableBody.appendChild(row);

                    // Add capabilities row for devices
                    if (currentTab === 'devices' && data.capabilities) {
                        const capRow = document.createElement('tr');
                        capRow.className = 'capabilities-row';
                        capRow.dataset.deviceId = relativeId;

                        const capTd = document.createElement('td');
                        capTd.colSpan = columns[currentTab].length;

                        const capPanel = document.createElement('div');
                        capPanel.className = 'capabilities-panel';

                        if (Array.isArray(data.capabilities) && data.capabilities.length > 0) {
                            data.capabilities.forEach(cap => {
                                const capItem = document.createElement('div');
                                capItem.className = 'capability-item';

                                const typeSpan = document.createElement('div');
                                typeSpan.className = 'capability-type';
                                typeSpan.textContent = cap.type || '-';

                                const stateSpan = document.createElement('div');
                                stateSpan.className = 'capability-state';
                                stateSpan.textContent = cap.state || '-';
                                stateSpan.title = cap.state || ''; // Tooltip for long IDs

                                const valueSpan = document.createElement('div');
                                valueSpan.className = 'capability-value';
                                valueSpan.textContent = '...';
                                if (cap.state) {
                                    valueSpan.dataset.oid = cap.state;
                                    valueSpan.classList.add('live-val');
                                }

                                const propsSpan = document.createElement('div');
                                propsSpan.className = 'capability-props';
                                const props = [];
                                if (cap.description) props.push(cap.description);
                                if (cap.min_value !== undefined) props.push(`min: ${cap.min_value}`);
                                if (cap.max_value !== undefined) props.push(`max: ${cap.max_value}`);
                                if (cap.unit) props.push(`unit: ${cap.unit}`);
                                if (cap.inverted) props.push('inverted');
                                propsSpan.textContent = props.length > 0 ? props.join(', ') : '-';

                                capItem.appendChild(typeSpan);
                                capItem.appendChild(stateSpan);
                                capItem.appendChild(valueSpan);
                                capItem.appendChild(propsSpan);
                                capItem.appendChild(propsSpan);
                                capPanel.appendChild(capItem);
                            });
                        } else {
                            const noCap = document.createElement('div');
                            noCap.className = 'no-capabilities';
                            noCap.textContent = 'No capabilities defined';
                            capPanel.appendChild(noCap);
                        }

                        capTd.appendChild(capPanel);
                        capRow.appendChild(capTd);
                        tableBody.appendChild(capRow);
                    }
                });
            });
        }

        // JSON Templates
        const templates = {
            devices: {
                name: 'New Device',
                type: 'light',
                room: 'livingroom',
                icon: 'üí°',
                capabilities: [
                    {
                        type: 'toggle',
                        state: 'adapter.0.device.state',
                        description: 'On/Off control'
                    }
                ],
                manufacturer: 'Unknown',
                model: 'Unknown',
                description: 'Device description'
            },
            rooms: {
                name: 'New Room',
                icon: 'üè†',
                metrics: []
            }
        };

        // Validation rules
        function validateConfig(type, config) {
            const errors = [];

            if (type === 'devices') {
                if (!config.name || typeof config.name !== 'string') {
                    errors.push('"name" is required and must be a string');
                }
                if (!config.type || typeof config.type !== 'string') {
                    errors.push('"type" is required and must be a string (e.g., light, window, socket)');
                }
                if (!config.room || typeof config.room !== 'string') {
                    errors.push('"room" is required and must be a string');
                }
                if (!config.icon || typeof config.icon !== 'string') {
                    errors.push('"icon" is required and must be a string (emoji)');
                }
                if (!Array.isArray(config.capabilities) || config.capabilities.length === 0) {
                    errors.push('"capabilities" is required and must be a non-empty array');
                } else {
                    config.capabilities.forEach((cap, i) => {
                        if (!cap.type) errors.push(`Capability ${i + 1}: "type" is required`);
                        if (!cap.state) errors.push(`Capability ${i + 1}: "state" is required`);
                    });
                }
            } else if (type === 'rooms') {
                if (!config.name || typeof config.name !== 'string') {
                    errors.push('"name" is required and must be a string');
                }
                if (!config.icon || typeof config.icon !== 'string') {
                    errors.push('"icon" is required and must be a string (emoji)');
                }
                if (config.metrics !== undefined && !Array.isArray(config.metrics)) {
                    errors.push('"metrics" must be an array if provided');
                }
            }

            return errors;
        }

        function openAddDialog() {
            const modal = document.getElementById('addModal');
            const title = document.getElementById('modalTitle');
            const idInput = document.getElementById('itemId');
            const configInput = document.getElementById('itemConfig');
            const errorEl = document.getElementById('errorMessage');

            title.textContent = currentTab === 'devices' ? 'Add New Device' : 'Add New Room';
            idInput.value = '';
            configInput.value = JSON.stringify(templates[currentTab], null, 2);
            errorEl.classList.remove('visible');
            errorEl.textContent = '';

            modal.classList.add('active');
        }

        function closeAddDialog() {
            document.getElementById('addModal').classList.remove('active');
        }

        function saveNewItem() {
            const idInput = document.getElementById('itemId');
            const configInput = document.getElementById('itemConfig');
            const errorEl = document.getElementById('errorMessage');

            const itemId = idInput.value.trim();
            const configText = configInput.value;

            // Validate ID
            if (!itemId) {
                errorEl.textContent = 'ID is required';
                errorEl.classList.add('visible');
                return;
            }

            if (!/^[a-z0-9_]+$/.test(itemId)) {
                errorEl.textContent = 'ID must contain only lowercase letters, numbers, and underscores';
                errorEl.classList.add('visible');
                return;
            }

            // Parse JSON
            let config;
            try {
                config = JSON.parse(configText);
            } catch (e) {
                errorEl.textContent = 'Invalid JSON: ' + e.message;
                errorEl.classList.add('visible');
                return;
            }

            // Validate config
            const validationErrors = validateConfig(currentTab, config);
            if (validationErrors.length > 0) {
                errorEl.innerHTML = 'Validation errors:<br>‚Ä¢ ' + validationErrors.join('<br>‚Ä¢ ');
                errorEl.classList.add('visible');
                return;
            }

            // Create object and state in ioBroker
            const stateId = `${currentBasePath}.${currentTab}.${itemId}`;
            const stateValue = JSON.stringify(config);

            console.log('Creating object:', stateId);

            // First create the object
            socket.emit('setObject', stateId, {
                type: 'state',
                common: {
                    name: config.name || itemId,
                    type: 'string', // We store JSON as string
                    role: 'json',
                    read: true,
                    write: true,
                    desc: 'Created by Home Controller'
                },
                native: {}
            }, (err) => {
                if (err) {
                    errorEl.textContent = 'Error creating object: ' + err;
                    errorEl.classList.add('visible');
                    return;
                }

                console.log('Object created, setting value:', stateValue);

                // Then set the state value
                socket.emit('setState', stateId, { val: stateValue, ack: true }, (err) => {
                    if (err) {
                        errorEl.textContent = 'Error setting state value: ' + err;
                        errorEl.classList.add('visible');
                        return;
                    }

                    console.log('State set successfully:', stateId);
                    closeAddDialog();
                    // Small delay to ensure state is indexed/available for list
                    setTimeout(loadData, 500);
                });
            });
        }

        // Close modal on overlay click
        document.getElementById('addModal').addEventListener('click', (e) => {
            if (e.target.id === 'addModal') {
                closeAddDialog();
            }
        });

        // Export functionality
        function exportData() {
            const targetPath = `${currentBasePath}.${currentTab}`;
            console.log('Exporting data from:', targetPath);

            socket.emit('getStates', targetPath + '.*', (err, states) => {
                if (err) {
                    alert('Error fetching data for export: ' + err);
                    return;
                }

                const items = {};
                Object.keys(states).sort().forEach(id => {
                    const relativeId = id.startsWith(targetPath + '.') ? id.substring(targetPath.length + 1) : id;
                    const val = states[id] ? states[id].val : null;

                    try {
                        items[relativeId] = val ? JSON.parse(val) : {};
                    } catch (e) {
                        console.warn('Failed to parse JSON for export:', id);
                        items[relativeId] = { _rawValue: val };
                    }
                });

                const exportData = {
                    type: currentTab,
                    exportedAt: new Date().toISOString(),
                    basePath: currentBasePath,
                    items: items
                };

                // Download as file
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `home_controller_${currentTab}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                console.log(`Exported ${Object.keys(items).length} ${currentTab}`);
            });
        }

        // Import functionality
        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importData = JSON.parse(e.target.result);

                    // Validate structure
                    if (!importData.type || !importData.items) {
                        alert('Invalid file format. Expected { type, items }');
                        return;
                    }

                    if (importData.type !== currentTab) {
                        if (!confirm(`File contains ${importData.type}, but current tab is ${currentTab}. Switch tab and import?`)) {
                            return;
                        }
                        switchTab(importData.type);
                    }

                    const items = importData.items;
                    const itemIds = Object.keys(items);

                    if (itemIds.length === 0) {
                        alert('No items found in file');
                        return;
                    }

                    // Validate all items first
                    const allErrors = [];
                    itemIds.forEach(id => {
                        if (!/^[a-z0-9_]+$/.test(id)) {
                            allErrors.push(`ID "${id}" is invalid (only lowercase, numbers, underscores)`);
                        }
                        const validationErrors = validateConfig(currentTab, items[id]);
                        validationErrors.forEach(err => {
                            allErrors.push(`${id}: ${err}`);
                        });
                    });

                    if (allErrors.length > 0) {
                        alert('Validation errors:\n‚Ä¢ ' + allErrors.slice(0, 10).join('\n‚Ä¢ ') +
                            (allErrors.length > 10 ? `\n... and ${allErrors.length - 10} more` : ''));
                        return;
                    }

                    // Confirm import
                    if (!confirm(`Import ${itemIds.length} ${currentTab}?\n\nThis will create or update:\n‚Ä¢ ${itemIds.slice(0, 5).join('\n‚Ä¢ ')}${itemIds.length > 5 ? '\n‚Ä¢ ...' : ''}`)) {
                        return;
                    }

                    // Import items
                    let completed = 0;
                    let errors = 0;

                    itemIds.forEach(id => {
                        const stateId = `${currentBasePath}.${currentTab}.${id}`;
                        const stateValue = JSON.stringify(items[id]);

                        socket.emit('setState', stateId, stateValue, (err) => {
                            if (err) {
                                console.error('Error importing', id, err);
                                errors++;
                            } else {
                                console.log('Imported:', id);
                            }
                            completed++;

                            if (completed === itemIds.length) {
                                alert(`Import complete!\n‚úÖ ${completed - errors} items imported\n${errors > 0 ? `‚ùå ${errors} errors` : ''}`);
                                loadData(); // Refresh table
                            }
                        });
                    });
                } catch (e) {
                    alert('Error parsing file: ' + e.message);
                }
            };
            reader.readAsText(file);

            // Reset file input so same file can be selected again
            event.target.value = '';
        }

        // Toggle capabilities panel
        function toggleCapabilities(iconElement) {
            const row = iconElement.closest('tr');
            const deviceId = row.dataset.deviceId;

            // Find the capabilities row
            const capRow = row.nextElementSibling;
            if (capRow && capRow.classList.contains('capabilities-row') && capRow.dataset.deviceId === deviceId) {
                const isExpanded = !capRow.classList.contains('visible');
                capRow.classList.toggle('visible');
                iconElement.classList.toggle('expanded');

                // Handle subscriptions
                const valueElements = capRow.querySelectorAll('.live-val');
                valueElements.forEach(el => {
                    const oid = el.dataset.oid;
                    if (oid) {
                        if (isExpanded) {
                            // Subscribe and get current value
                            socket.emit('subscribe', oid);
                            socket.emit('getState', oid, (err, state) => {
                                if (!err && state) {
                                    updateValueDisplay(el, state.val);
                                }
                            });
                        } else {
                            // Unsubscribe when collapsing (optional, but saves traffic)
                            socket.emit('unsubscribe', oid);
                        }
                    }
                });
            }
        }

        function updateValueDisplay(element, value) {
            if (value === null || value === undefined) {
                element.textContent = '-';
                element.classList.remove('active');
            } else {
                element.textContent = value.toString();
                // Helper visualization for booleans
                if (typeof value === 'boolean') {
                    if (value) {
                        element.textContent = 'TRUE';
                        element.classList.add('active');
                    } else {
                        element.textContent = 'FALSE';
                        element.classList.remove('active');
                    }
                }
            }
        }

        socket.on('disconnect', () => {
            console.log('Disconnected from ioBroker');
            statusEl.textContent = 'Disconnected';
            statusEl.style.background = '#ef4444';
        });

        console.log('Home Controller Tab loaded');

        // WebSocket Clients display
        function loadConnectedClients() {
            socket.emit('getState', 'home_controller_backend.0.info.connectedClients', (err, state) => {
                if (err || !state) {
                    console.log('No connected clients state found');
                    return;
                }
                updateClientsDisplay(state.val);
            });
        }

        function updateClientsDisplay(clientsJson) {
            const clientsList = document.getElementById('clientsList');
            let clients = [];

            try {
                clients = JSON.parse(clientsJson) || [];
            } catch (e) {
                console.warn('Failed to parse clients JSON:', e);
                clients = [];
            }

            if (clients.length === 0) {
                clientsList.innerHTML = '<span class="no-clients">No clients connected</span>';
                return;
            }

            clientsList.innerHTML = clients.map((client, idx) => {
                const icon = client.clientType === 'mobile' ? 'üì±' :
                    client.clientType === 'web' ? 'üåê' :
                        client.clientType === 'desktop' ? 'üíª' : 'üîå';

                const logCount = client.recentRequests?.length || 0;
                const logsHtml = client.recentRequests && client.recentRequests.length > 0
                    ? client.recentRequests.map(req => {
                        const time = new Date(req.timestamp).toLocaleTimeString('de-DE', {
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        });
                        return `
                            <div class="log-entry">
                                <span class="log-time">${time}</span>
                                <span class="log-type">${req.type}</span>
                                <span class="log-id">${req.id || '-'}</span>
                            </div>
                        `;
                    }).join('')
                    : '<div class="no-logs">No requests yet</div>';

                return `
                    <div class="client-wrapper">
                        <div class="client-badge">
                            <span class="client-icon">${icon}</span>
                            <span class="client-name">${client.name}</span>
                            <span class="client-version">v${client.version}</span>
                            <span class="client-logs-toggle" onclick="toggleLogs(${idx})" title="Show request logs">
                                üìã Logs (${logCount})
                            </span>
                            <span class="client-close" onclick="disconnectClient('${client.id}')" title="Disconnect client">‚úï</span>
                        </div>
                        <div class="client-logs-panel" id="logs-${idx}">
                            ${logsHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleLogs(clientIdx) {
            const panel = document.getElementById(`logs-${clientIdx}`);
            if (panel) {
                panel.classList.toggle('visible');
            }
        }

        function disconnectClient(clientId) {
            if (!confirm('Disconnect this client?')) return;

            console.log('Disconnecting client:', clientId);
            socket.emit('sendTo', 'home_controller_backend.0', 'disconnectClient', clientId, (result) => {
                if (result && result.success) {
                    console.log('Client disconnected successfully');
                } else {
                    console.error('Failed to disconnect client');
                    alert('Failed to disconnect client');
                }
            });
        }

        // Listen for client state changes
        socket.on('stateChange', (id, state) => {
            if (id === 'home_controller_backend.0.info.connectedClients' && state) {
                updateClientsDisplay(state.val);
            }

            // Update live values in capabilities panel
            if (state) {
                // Escape special characters in ID for querySelector
                const escapedId = id.replace(/([.\\:])/g, '\\$1');
                try {
                    const valEls = document.querySelectorAll(`.live-val[data-oid="${id}"]`);
                    valEls.forEach(el => updateValueDisplay(el, state.val));
                } catch (e) {
                    console.error('Error updating value display:', e);
                }
            }
        });
    </script>
</body>

</html>