{
  "version": 3,
  "sources": ["../../src/lib/websocket-server.ts"],
  "sourcesContent": ["/**\n * WebSocket Server for Home Controller Adapter\n *\n * Provides a WebSocket API for clients to:\n * - Register with the adapter\n * - Fetch devices and rooms\n * - (Future) Subscribe to state changes\n */\n\n/* eslint-disable jsdoc/require-param, jsdoc/require-jsdoc */\n\nimport { WebSocket, WebSocketServer as WSServer } from \"ws\";\nimport type { IncomingMessage, Server as HttpServer, ServerResponse } from \"http\";\nimport { createServer as createHttpServer } from \"http\";\nimport type { Server as HttpsServer } from \"https\";\nimport { createServer as createHttpsServer } from \"https\";\nimport fs from \"fs\";\nimport type { BaseMessage, ConnectedClient, InitialSnapshotResponse, ErrorMessage, ErrorCode } from \"./websocket/types\";\nimport { SnapshotService } from \"./services/snapshot-service\";\nimport { ErrorCodes } from \"./websocket/types\";\nimport type { HandlerContext } from \"./websocket/handlers\";\nimport { routeMessage } from \"./websocket/routes\";\nimport { StateChangeManager } from \"./websocket/state-change\";\nimport { SubscriptionRegistry } from \"./websocket/subscriptions\";\nimport { validateIncoming } from \"./websocket/codec\";\nimport { RoomMetricsManager } from \"./websocket/room-metrics\";\nimport type { AdapterInterface } from \"./websocket/adapter-interface\";\nimport { AuthService } from \"./websocket/auth\";\n\n// Re-export for convenience\nexport { ErrorCodes } from \"./websocket/types\";\n\n/**\n * WebSocket Server class for Home Controller\n */\nexport class HomeControllerWebSocketServer {\n\tprivate wss: WSServer | null = null;\n\tprivate server: HttpServer | HttpsServer | null = null;\n\tprivate clients: Map<WebSocket, ConnectedClient> = new Map();\n\tprivate adapter: AdapterInterface;\n\tprivate serverVersion = \"0.0.1\";\n\tprivate protocolVersion = \"1.0\";\n\tprivate schemaVersion = \"1.0\";\n\tprivate seqCounter = 0;\n\tprivate snapshotService: SnapshotService;\n\tprivate heartbeatInterval: NodeJS.Timeout | null = null;\n\tprivate readonly pingIntervalMs = 28000;\n\tprivate readonly pingTimeoutMs = 10000;\n\tprivate socketMeta: WeakMap<WebSocket, { isAlive: boolean; idleTimer?: NodeJS.Timeout }> = new WeakMap();\n\tprivate subscriptions: SubscriptionRegistry;\n\tprivate onClientChangeCallback: ((clients: ConnectedClient[]) => void) | null = null;\n\tprivate authService: AuthService;\n\n\t// Map stateId -> list of capabilities that use it\n\tprivate stateChangeManager: StateChangeManager;\n\tprivate roomMetricsManager: RoomMetricsManager;\n\n\tconstructor(adapter: AdapterInterface) {\n\t\tthis.adapter = adapter;\n\t\tthis.snapshotService = new SnapshotService(adapter);\n\t\tthis.subscriptions = new SubscriptionRegistry({\n\t\t\tdefaultSubscription: this.adapter.config.defaultSubscription ?? \"all\",\n\t\t});\n\t\tthis.stateChangeManager = new StateChangeManager(\n\t\t\t{\n\t\t\t\tadapter: this.adapter,\n\t\t\t\tsnapshotService: this.snapshotService,\n\t\t\t\tclients: this.clients,\n\t\t\t\tsend: (ws: WebSocket, msg: BaseMessage) => this.send(ws, msg),\n\t\t\t},\n\t\t\tthis.subscriptions,\n\t\t);\n\t\tthis.roomMetricsManager = new RoomMetricsManager({\n\t\t\tadapter: this.adapter,\n\t\t\tsnapshotService: this.snapshotService,\n\t\t\tclients: this.clients,\n\t\t\tsubscriptions: this.subscriptions,\n\t\t\tsend: (ws: WebSocket, msg: BaseMessage) => this.send(ws, msg),\n\t\t});\n\t\tthis.authService = new AuthService(adapter);\n\t}\n\n\t/**\n\t * Set callback for when clients connect/disconnect\n\t */\n\tpublic onClientChange(callback: (clients: ConnectedClient[]) => void): void {\n\t\tthis.onClientChangeCallback = callback;\n\t}\n\n\t/**\n\t * Notify about client changes\n\t */\n\tprivate notifyClientChange(): void {\n\t\tif (this.onClientChangeCallback) {\n\t\t\tthis.onClientChangeCallback(this.getConnectedClients());\n\t\t}\n\t}\n\n\t/**\n\t * Start the WebSocket server\n\t */\n\tpublic async start(): Promise<void> {\n\t\tawait this.authService.init();\n\n\t\tthis.server = this.buildHttpServer();\n\n\t\tthis.wss = new WSServer({\n\t\t\tserver: this.server,\n\t\t\tperMessageDeflate: true,\n\t\t});\n\n\t\tthis.wss.on(\"connection\", (ws: WebSocket, req: IncomingMessage) => {\n\t\t\tconst auth = this.authenticate(req);\n\t\t\tif (!auth.ok) {\n\t\t\t\tthis.adapter.log.warn(`Rejected connection: ${auth.reason ?? \"auth failed\"}`);\n\t\t\t\tws.close(auth.closeCode ?? 4001, auth.reason ?? \"AUTH_FAILED\");\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis.handleConnection(ws, req, auth.user);\n\t\t});\n\n\t\t// Initial subscription to all known states\n\t\tvoid this.stateChangeManager.subscribeToAllStates();\n\t\t// Subscribe to room metrics states\n\t\tvoid this.roomMetricsManager.subscribeToAllMetrics();\n\n\t\tthis.wss.on(\"error\", (error: Error) => {\n\t\t\tthis.adapter.log.error(`WebSocket server error: ${error.message}`);\n\t\t});\n\n\t\tthis.heartbeatInterval = setInterval(() => this.checkHeartbeats(), this.pingIntervalMs);\n\n\t\tthis.server.listen(this.adapter.config.wsPort, () => {\n\t\t\tconst scheme = this.adapter.config.wsUseTls ? \"wss\" : \"ws\";\n\t\t\tthis.adapter.log.info(`WebSocket server started on ${scheme}://0.0.0.0:${this.adapter.config.wsPort}`);\n\t\t});\n\t}\n\n\t/**\n\t * Handle state change from adapter\n\t */\n\tpublic handleStateChange(id: string, state: ioBroker.State): void {\n\t\tthis.stateChangeManager.handleStateChange(id, state);\n\t\tthis.roomMetricsManager.handleStateChange(id, state);\n\t}\n\n\t/**\n\t * Stop the WebSocket server\n\t */\n\tpublic stop(): void {\n\t\tif (this.wss) {\n\t\t\tif (this.heartbeatInterval) {\n\t\t\t\tclearInterval(this.heartbeatInterval);\n\t\t\t\tthis.heartbeatInterval = null;\n\t\t\t}\n\t\t\t// Close all client connections\n\t\t\tfor (const ws of this.clients.keys()) {\n\t\t\t\tws.close(1001, \"Server shutting down\");\n\t\t\t}\n\t\t\tthis.clients.clear();\n\n\t\t\tthis.wss.close();\n\t\t\tthis.wss = null;\n\t\t\tthis.adapter.log.info(\"WebSocket server stopped\");\n\t\t}\n\t\tif (this.server) {\n\t\t\tthis.server.close();\n\t\t\tthis.server = null;\n\t\t}\n\t}\n\n\t/**\n\t * Get number of connected clients\n\t */\n\tpublic getClientCount(): number {\n\t\treturn this.clients.size;\n\t}\n\n\t/**\n\t * Get list of connected clients (for admin UI)\n\t */\n\tpublic getConnectedClients(): ConnectedClient[] {\n\t\treturn Array.from(this.clients.values()).filter(c => c.isRegistered);\n\t}\n\n\t/**\n\t * Disconnect a client by ID\n\t */\n\tpublic disconnectClient(clientId: string): boolean {\n\t\tfor (const [ws, client] of this.clients.entries()) {\n\t\t\tif (client.id === clientId) {\n\t\t\t\tthis.adapter.log.info(`Disconnecting client ${client.name} (${clientId}) by admin request`);\n\t\t\t\tws.close(1000, \"Disconnected by administrator\");\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\t/**\n\t * Handle new WebSocket connection\n\t */\n\tprivate handleConnection(ws: WebSocket, _req: IncomingMessage, authUser?: string): void {\n\t\tthis.adapter.log.debug(\"New WebSocket connection\");\n\n\t\tthis.socketMeta.set(ws, { isAlive: true });\n\t\tws.on(\"pong\", () => {\n\t\t\tconst meta = this.socketMeta.get(ws);\n\t\t\tif (meta) {\n\t\t\t\tmeta.isAlive = true;\n\t\t\t}\n\t\t});\n\n\t\t// Store client as unregistered initially\n\t\tthis.clients.set(ws, {\n\t\t\tid: \"\",\n\t\t\tname: \"\",\n\t\t\tversion: \"\",\n\t\t\tclientType: \"\",\n\t\t\tconnectedAt: new Date(),\n\t\t\tisRegistered: false,\n\t\t\trecentRequests: [],\n\t\t\tauthUser,\n\t\t});\n\n\t\tws.on(\"message\", (data: Buffer) => {\n\t\t\tthis.handleMessage(ws, data);\n\t\t});\n\n\t\tws.on(\"close\", () => {\n\t\t\tconst client = this.clients.get(ws);\n\t\t\tif (client?.isRegistered) {\n\t\t\t\tthis.adapter.log.info(`Client disconnected: ${client.name} (${client.id})`);\n\t\t\t} else {\n\t\t\t\tthis.adapter.log.debug(\"Unregistered client disconnected\");\n\t\t\t}\n\t\t\tthis.clients.delete(ws);\n\t\t\tconst meta = this.socketMeta.get(ws);\n\t\t\tif (meta?.idleTimer) {\n\t\t\t\tclearTimeout(meta.idleTimer);\n\t\t\t}\n\t\t\tthis.socketMeta.delete(ws);\n\t\t\tthis.notifyClientChange();\n\t\t});\n\n\t\tws.on(\"error\", (error: Error) => {\n\t\t\tthis.adapter.log.warn(`WebSocket client error: ${error.message}`);\n\t\t});\n\t}\n\n\t/**\n\t * Handle incoming message from client\n\t */\n\tprivate handleMessage(ws: WebSocket, data: Buffer): void {\n\t\tlet message: BaseMessage;\n\n\t\ttry {\n\t\t\tmessage = JSON.parse(data.toString()) as BaseMessage;\n\t\t} catch {\n\t\t\tthis.sendError(ws, undefined, ErrorCodes.INVALID_MESSAGE, \"Invalid JSON\");\n\t\t\treturn;\n\t\t}\n\n\t\tif (!message.type) {\n\t\t\tthis.sendError(ws, message.id, ErrorCodes.INVALID_MESSAGE, \"Missing message type\");\n\t\t\treturn;\n\t\t}\n\n\t\tconst validation = validateIncoming(message);\n\t\tif (!validation.ok) {\n\t\t\tthis.sendError(\n\t\t\t\tws,\n\t\t\t\tmessage.id,\n\t\t\t\tErrorCodes.INVALID_PAYLOAD,\n\t\t\t\tvalidation.errors?.join(\"; \") ?? \"Invalid payload\",\n\t\t\t);\n\t\t\treturn;\n\t\t}\n\n\t\tthis.adapter.log.debug(`Received message: ${message.type}`);\n\n\t\t// Log the request for debugging\n\t\tthis.logRequest(ws, message.type, message.id);\n\n\t\t// Route message to handler\n\t\trouteMessage(this.buildHandlerContext(), ws, message);\n\t}\n\n\tprivate updateTimeout: NodeJS.Timeout | null = null;\n\n\t/**\n\t * Trigger a throttled update for logs\n\t */\n\tprivate triggerLogUpdate(): void {\n\t\tif (this.updateTimeout) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.updateTimeout = setTimeout(() => {\n\t\t\tthis.updateTimeout = null;\n\t\t\tthis.notifyClientChange();\n\t\t}, 2000);\n\t}\n\n\t/**\n\t * Log a request from a client\n\t */\n\tprivate logRequest(ws: WebSocket, type: string, id?: string): void {\n\t\tconst client = this.clients.get(ws);\n\t\tif (client) {\n\t\t\tclient.recentRequests.unshift({\n\t\t\t\ttimestamp: new Date(),\n\t\t\t\ttype: type,\n\t\t\t\tid: id,\n\t\t\t});\n\n\t\t\t// Keep only last 10\n\t\t\tif (client.recentRequests.length > 10) {\n\t\t\t\tclient.recentRequests.pop();\n\t\t\t}\n\n\t\t\t// Update state to show logs in Admin UI\n\t\t\t// Use throttled update to avoid flooding ioBroker with state changes\n\t\t\tthis.triggerLogUpdate();\n\t\t}\n\t}\n\n\t/**\n\t * Send message to client\n\t */\n\tprivate send(ws: WebSocket, message: BaseMessage): void {\n\t\tif (ws.readyState === WebSocket.OPEN) {\n\t\t\tconst enriched: BaseMessage = {\n\t\t\t\t...message,\n\t\t\t\tseq: message.seq ?? this.nextSeq(),\n\t\t\t\tts: message.ts ?? new Date().toISOString(),\n\t\t\t\tversion: message.version ?? this.schemaVersion,\n\t\t\t};\n\t\t\tws.send(JSON.stringify(enriched));\n\t\t}\n\t}\n\n\t/**\n\t * Send error message to client\n\t */\n\tprivate sendError(ws: WebSocket, id: string | undefined, code: ErrorCode, message: string): void {\n\t\tconst errorMsg: ErrorMessage = {\n\t\t\ttype: \"error\",\n\t\t\tid,\n\t\t\terror: { code, message },\n\t\t};\n\t\tthis.send(ws, errorMsg);\n\t}\n\n\tprivate buildHandlerContext(): HandlerContext {\n\t\treturn {\n\t\t\tadapter: this.adapter,\n\t\t\tclients: this.clients,\n\t\t\tsnapshotService: this.snapshotService,\n\t\t\tnextSeq: () => this.nextSeq(),\n\t\t\tgetSeq: () => this.seqCounter,\n\t\t\tserverVersion: this.serverVersion,\n\t\t\tprotocolVersion: this.protocolVersion,\n\t\t\tschemaVersion: this.schemaVersion,\n\t\t\tsubscriptions: this.subscriptions,\n\t\t\tsend: (socket: WebSocket, msg: BaseMessage) => this.send(socket, msg),\n\t\t\tsendError: (socket: WebSocket, id: string | undefined, code: string, msg: string) =>\n\t\t\t\tthis.sendError(socket, id, code as ErrorCode, msg),\n\t\t\tnotifyClientChange: () => this.notifyClientChange(),\n\t\t};\n\t}\n\n\t/**\n\t * Send initial snapshot after registration\n\t */\n\tprivate async sendInitialSnapshot(ws: WebSocket): Promise<void> {\n\t\tconst client = this.clients.get(ws);\n\t\tif (!client?.isRegistered) {\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\tconst seq = this.nextSeq();\n\t\t\tconst snapshot = await this.snapshotService.buildSnapshot(seq);\n\t\t\tconst response: InitialSnapshotResponse = {\n\t\t\t\ttype: \"initialSnapshot\",\n\t\t\t\tpayload: { ...snapshot },\n\t\t\t\tseq,\n\t\t\t};\n\t\t\tthis.send(ws, response);\n\t\t} catch (error) {\n\t\t\tthis.adapter.log.warn(`Failed to send initialSnapshot: ${(error as Error).message}`);\n\t\t}\n\t}\n\n\t/**\n\t * Authenticate incoming connection (Basic or none)\n\t */\n\tprivate authenticate(req: IncomingMessage): { ok: boolean; user?: string; closeCode?: number; reason?: string } {\n\t\tconst mode = this.adapter.config.authMode ?? \"none\";\n\t\tif (mode === \"none\") {\n\t\t\treturn { ok: true };\n\t\t}\n\n\t\tif (mode === \"token\") {\n\t\t\tconst result = this.authService.authenticateUpgrade(req);\n\t\t\tif (result.ok) {\n\t\t\t\treturn { ok: true, user: result.user };\n\t\t\t}\n\t\t\tconst closeCode = result.reason === \"TOKEN_EXPIRED\" ? 4002 : 4001;\n\t\t\treturn { ok: false, closeCode, reason: result.reason ?? \"AUTH_FAILED\" };\n\t\t}\n\n\t\tif (mode === \"basic\") {\n\t\t\tconst header = req.headers.authorization;\n\t\t\tif (!header || !header.startsWith(\"Basic \")) {\n\t\t\t\treturn { ok: false, closeCode: 4001, reason: \"AUTH_FAILED\" };\n\t\t\t}\n\n\t\t\tconst token = header.substring(\"Basic \".length);\n\t\t\tconst decoded = Buffer.from(token, \"base64\").toString(\"utf8\");\n\t\t\tconst [user, pass] = decoded.split(\":\");\n\t\t\tif (!user || pass === undefined) {\n\t\t\t\treturn { ok: false, closeCode: 4001, reason: \"AUTH_FAILED\" };\n\t\t\t}\n\n\t\t\tconst expectedUser = this.adapter.config.authUser;\n\t\t\tconst expectedPass = this.adapter.config.authPassword;\n\t\t\tif (expectedUser && expectedPass) {\n\t\t\t\tif (user === expectedUser && pass === expectedPass) {\n\t\t\t\t\treturn { ok: true };\n\t\t\t\t}\n\t\t\t\treturn { ok: false, closeCode: 4001, reason: \"AUTH_FAILED\" };\n\t\t\t}\n\n\t\t\t// If no credentials configured, allow but warn\n\t\t\tthis.adapter.log.warn(\n\t\t\t\t\"Auth mode 'basic' is enabled but no credentials are configured; allowing connection.\",\n\t\t\t);\n\t\t\treturn { ok: true };\n\t\t}\n\n\t\treturn { ok: false, closeCode: 4004, reason: \"PROTOCOL_VERSION_UNSUPPORTED\" };\n\t}\n\n\tprivate buildHttpServer(): HttpServer {\n\t\tif (this.adapter.config.wsUseTls) {\n\t\t\ttry {\n\t\t\t\tconst certPath = this.adapter.config.wsTlsCertPath;\n\t\t\t\tconst keyPath = this.adapter.config.wsTlsKeyPath;\n\t\t\t\tif (!certPath || !keyPath) {\n\t\t\t\t\tthrow new Error(\"TLS enabled but cert/key paths are missing\");\n\t\t\t\t}\n\t\t\t\tconst cert = fs.readFileSync(certPath);\n\t\t\t\tconst key = fs.readFileSync(keyPath);\n\t\t\t\treturn createHttpsServer({ cert, key }, (req, res) => void this.handleHttp(req, res));\n\t\t\t} catch (error) {\n\t\t\t\tthis.adapter.log.error(`Failed to start HTTPS server: ${(error as Error).message}`);\n\t\t\t\tthrow error;\n\t\t\t}\n\t\t}\n\n\t\treturn createHttpServer((req, res) => void this.handleHttp(req, res));\n\t}\n\n\tprivate async handleHttp(req: IncomingMessage, res: ServerResponse): Promise<void> {\n\t\tif (req.url?.startsWith(\"/token\") && req.method === \"POST\") {\n\t\t\tawait this.handleTokenRequest(req, res);\n\t\t\treturn;\n\t\t}\n\n\t\tres.statusCode = 404;\n\t\tres.setHeader(\"Content-Type\", \"application/json\");\n\t\tres.end(JSON.stringify({ error: \"Not found\" }));\n\t}\n\n\tprivate async handleTokenRequest(req: IncomingMessage, res: ServerResponse): Promise<void> {\n\t\tif ((this.adapter.config.authMode ?? \"none\") !== \"token\") {\n\t\t\tres.setHeader(\"Content-Type\", \"application/json\");\n\t\t\tres.statusCode = 400;\n\t\t\tres.end(JSON.stringify({ error: \"Token mode disabled\" }));\n\t\t\treturn;\n\t\t}\n\n\t\tlet body = \"\";\n\t\tawait new Promise<void>((resolve, reject) => {\n\t\t\treq.on(\"data\", (chunk: Buffer) => {\n\t\t\t\tbody += chunk.toString(\"utf8\");\n\t\t\t\tif (body.length > 10240) {\n\t\t\t\t\treject(new Error(\"Body too large\"));\n\t\t\t\t}\n\t\t\t});\n\t\t\treq.on(\"end\", () => resolve());\n\t\t\treq.on(\"error\", reject);\n\t\t}).catch((err: Error) => {\n\t\t\tthis.adapter.log.warn(`Failed to read token request: ${err.message}`);\n\t\t});\n\n\t\tres.setHeader(\"Content-Type\", \"application/json\");\n\n\t\tif (!body) {\n\t\t\tres.statusCode = 400;\n\t\t\tres.end(JSON.stringify({ error: \"Empty body\" }));\n\t\t\treturn;\n\t\t}\n\n\t\tlet parsed: any;\n\t\ttry {\n\t\t\tparsed = JSON.parse(body);\n\t\t} catch {\n\t\t\tres.statusCode = 400;\n\t\t\tres.end(JSON.stringify({ error: \"Invalid JSON\" }));\n\t\t\treturn;\n\t\t}\n\n\t\tconst username = parsed.username as string;\n\t\tconst password = parsed.password as string;\n\t\tconst ttl = parsed.ttlSeconds as number | undefined;\n\n\t\tif (!username || !password) {\n\t\t\tres.statusCode = 400;\n\t\t\tres.end(JSON.stringify({ error: \"username and password required\" }));\n\t\t\treturn;\n\t\t}\n\n\t\tconst result = await this.authService.issueTokenForUser(username, password, ttl);\n\t\tif (!result.ok) {\n\t\t\tres.statusCode = 401;\n\t\t\tres.end(JSON.stringify({ error: result.reason ?? \"AUTH_FAILED\" }));\n\t\t\treturn;\n\t\t}\n\n\t\tres.statusCode = 200;\n\t\tres.end(JSON.stringify({ token: result.token, expiresAt: result.expiresAt }));\n\t}\n\n\t/**\n\t * Heartbeat loop: ping and close idle sockets\n\t */\n\tprivate checkHeartbeats(): void {\n\t\tfor (const ws of this.clients.keys()) {\n\t\t\tconst meta = this.socketMeta.get(ws);\n\t\t\tif (!meta) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tif (!meta.isAlive) {\n\t\t\t\tws.close(4008, \"IDLE_TIMEOUT\");\n\t\t\t\tthis.clients.delete(ws);\n\t\t\t\tif (meta.idleTimer) {\n\t\t\t\t\tclearTimeout(meta.idleTimer);\n\t\t\t\t}\n\t\t\t\tthis.socketMeta.delete(ws);\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tmeta.isAlive = false;\n\t\t\tif (ws.readyState === WebSocket.OPEN) {\n\t\t\t\tws.ping();\n\t\t\t\tif (meta.idleTimer) {\n\t\t\t\t\tclearTimeout(meta.idleTimer);\n\t\t\t\t}\n\t\t\t\tmeta.idleTimer = setTimeout(() => {\n\t\t\t\t\tconst stillMeta = this.socketMeta.get(ws);\n\t\t\t\t\tif (stillMeta && !stillMeta.isAlive && ws.readyState === WebSocket.OPEN) {\n\t\t\t\t\t\tws.close(4008, \"IDLE_TIMEOUT\");\n\t\t\t\t\t\tthis.clients.delete(ws);\n\t\t\t\t\t\tthis.socketMeta.delete(ws);\n\t\t\t\t\t}\n\t\t\t\t}, this.pingTimeoutMs);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Generate next sequence number\n\t */\n\tprivate nextSeq(): number {\n\t\tthis.seqCounter += 1;\n\t\treturn this.seqCounter;\n\t}\n}\n"],
  "mappings": "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",
  "names": ["import_types", "WSServer", "fs", "createHttpsServer", "createHttpServer"]
}
