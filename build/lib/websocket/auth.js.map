{
  "version": 3,
  "sources": ["../../../src/lib/websocket/auth.ts"],
  "sourcesContent": ["/* eslint-disable jsdoc/require-jsdoc */\nimport crypto from \"crypto\";\nimport type { IncomingMessage } from \"http\";\nimport { URL } from \"url\";\nimport type { AdapterInterface } from \"./adapter-interface\";\n\ntype TokenPayload = {\n\tuser: string;\n\texp: number;\n\tiat: number;\n\tscope?: string[];\n\tkind?: \"access\";\n};\n\nexport type AuthResult = { ok: true; user: string } | { ok: false; reason: string };\n\nexport class AuthService {\n\tprivate secret: string | null = null;\n\tprivate staticToken: string | undefined;\n\n\tpublic constructor(private readonly adapter: AdapterInterface) {}\n\n\tpublic async init(): Promise<void> {\n\t\tthis.secret = await this.loadSecret();\n\t\tthis.staticToken = this.adapter.config.staticToken?.trim() || undefined;\n\t}\n\n\tpublic getDefaultTtlSeconds(): number {\n\t\tconst ttl = this.adapter.config.tokenTtlSeconds ?? 3600;\n\t\treturn ttl < 60 ? 60 : ttl;\n\t}\n\n\tpublic async issueTokenForUser(\n\t\tusername: string,\n\t\tpassword: string,\n\t\tttlSeconds?: number,\n\t): Promise<{ ok: true; token: string; expiresAt: number } | { ok: false; reason: string }> {\n\t\tif (!username || !password) {\n\t\t\treturn { ok: false, reason: \"INVALID_CREDENTIALS\" };\n\t\t}\n\n\t\tconst userObj = await this.adapter.getForeignObjectAsync?.(`system.user.${username}`).catch(error => {\n\t\t\tthis.adapter.log.warn(`User lookup failed for ${username}: ${(error as Error).message}`);\n\t\t\treturn null;\n\t\t});\n\n\t\tif (!userObj || userObj.type !== \"user\") {\n\t\t\tthis.adapter.log.warn(`Token request rejected: user ${username} not found`);\n\t\t\treturn { ok: false, reason: \"USER_NOT_FOUND\" };\n\t\t}\n\n\t\tif (userObj.common?.enabled === false) {\n\t\t\tthis.adapter.log.warn(`Token request rejected: user ${username} is disabled`);\n\t\t\treturn { ok: false, reason: \"USER_NOT_FOUND\" };\n\t\t}\n\n\t\tconst storedHash = userObj.common?.password as string | undefined;\n\t\tif (!storedHash || storedHash.trim().length === 0) {\n\t\t\tthis.adapter.log.warn(`Token request rejected: user ${username} has no password set`);\n\t\t\treturn { ok: false, reason: \"NO_PASSWORD_SET\" };\n\t\t}\n\n\t\tconst userId = userObj._id ?? `system.user.${username}`;\n\n\t\ttry {\n\t\t\tconst [passwordValid] = await this.adapter.checkPasswordAsync(userId, password);\n\t\t\t\n\t\t\tif (!passwordValid) {\n\t\t\t\tthis.adapter.log.warn(`Token request rejected: invalid password for user ${username}`);\n\t\t\t\treturn { ok: false, reason: \"INVALID_CREDENTIALS\" };\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tthis.adapter.log.error(`Password check failed for ${username}: ${(error as Error).message}`);\n\t\t\treturn { ok: false, reason: \"AUTH_ERROR\" };\n\t\t}\n\n\t\tthis.adapter.log.info(`Token issued successfully for user: ${username}`);\n\n\t\tconst now = Math.floor(Date.now() / 1000);\n\t\tconst exp = now + (ttlSeconds ?? this.getDefaultTtlSeconds());\n\t\tconst payload: TokenPayload = {\n\t\t\tuser: username,\n\t\t\texp,\n\t\t\tiat: now,\n\t\t\tkind: \"access\",\n\t\t};\n\n\t\treturn { ok: true, token: this.sign(payload), expiresAt: exp };\n\t}\n\n\tpublic authenticateUpgrade(req: IncomingMessage): AuthResult {\n\t\tconst token = this.extractToken(req);\n\t\tif (!token) {\n\t\t\treturn { ok: false, reason: \"MISSING_TOKEN\" };\n\t\t}\n\t\treturn this.verifyToken(token);\n\t}\n\n\tpublic verifyToken(token: string): AuthResult {\n\t\tconst secret = this.secret;\n\t\tif (!secret) {\n\t\t\treturn { ok: false, reason: \"NO_SECRET\" };\n\t\t}\n\n\t\tconst payload = this.decode(token, secret);\n\t\tif (!payload) {\n\t\t\treturn { ok: false, reason: \"INVALID_TOKEN\" };\n\t\t}\n\n\t\tif (this.staticToken && token === this.staticToken) {\n\t\t\t// static token is still subject to exp check below\n\t\t}\n\n\t\tconst now = Math.floor(Date.now() / 1000);\n\t\tif (payload.exp <= now) {\n\t\t\treturn { ok: false, reason: \"TOKEN_EXPIRED\" };\n\t\t}\n\n\t\treturn { ok: true, user: payload.user };\n\t}\n\n\tprivate sign(payload: TokenPayload): string {\n\t\tif (!this.secret) {\n\t\t\tthrow new Error(\"AuthService not initialized\");\n\t\t}\n\t\tconst payloadStr = Buffer.from(JSON.stringify(payload)).toString(\"base64url\");\n\t\tconst sig = crypto.createHmac(\"sha256\", this.secret).update(payloadStr).digest(\"base64url\");\n\t\treturn `${payloadStr}.${sig}`;\n\t}\n\n\tprivate decode(token: string, secret: string): TokenPayload | null {\n\t\tconst [payloadB64, sig] = token.split(\".\");\n\t\tif (!payloadB64 || !sig) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst expectedSig = crypto.createHmac(\"sha256\", secret).update(payloadB64).digest(\"base64url\");\n\t\tconst provided = Buffer.from(sig);\n\t\tconst expected = Buffer.from(expectedSig);\n\t\tif (provided.length !== expected.length) {\n\t\t\treturn null;\n\t\t}\n\t\tif (!crypto.timingSafeEqual(provided, expected)) {\n\t\t\treturn null;\n\t\t}\n\n\t\ttry {\n\t\t\tconst json = Buffer.from(payloadB64, \"base64url\").toString(\"utf8\");\n\t\t\treturn JSON.parse(json) as TokenPayload;\n\t\t} catch {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tprivate extractToken(req: IncomingMessage): string | null {\n\t\tconst authHeader = req.headers.authorization;\n\t\tif (authHeader?.startsWith(\"Bearer \")) {\n\t\t\treturn authHeader.substring(\"Bearer \".length).trim();\n\t\t}\n\n\t\tconst url = this.parseUrl(req);\n\t\tif (url) {\n\t\t\tconst token = url.searchParams.get(\"token\");\n\t\t\tif (token) {\n\t\t\t\treturn token;\n\t\t\t}\n\t\t}\n\n\t\treturn null;\n\t}\n\n\tprivate parseUrl(req: IncomingMessage): URL | null {\n\t\ttry {\n\t\t\tconst host = req.headers.host ?? \"localhost\";\n\t\t\treturn new URL(req.url ?? \"/\", `http://${host}`);\n\t\t} catch {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tprivate async loadSecret(): Promise<string> {\n\t\ttry {\n\t\t\tconst systemConfig = await this.adapter.getForeignObjectAsync?.(\"system.config\");\n\t\t\tconst secret = systemConfig?.native?.secret as string | undefined;\n\t\t\tif (secret) {\n\t\t\t\treturn secret;\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tthis.adapter.log.warn(`Could not read ioBroker secret: ${(error as Error).message}`);\n\t\t}\n\t\tconst envSecret = process.env.IOB_SECRET || process.env.IOBROKER_SECRET;\n\t\tif (envSecret) {\n\t\t\tthis.adapter.log.warn(\"Using IOB_SECRET/IOBROKER_SECRET from environment as fallback secret\");\n\t\t\treturn envSecret;\n\t\t}\n\t\tthrow new Error(\"ioBroker secret not available\");\n\t}\n}\n\n"],
  "mappings": "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",
  "names": ["crypto"]
}
