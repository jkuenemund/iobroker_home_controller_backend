{
  "version": 3,
  "sources": ["../../../src/lib/websocket/codec.ts"],
  "sourcesContent": ["/* eslint-disable jsdoc/require-jsdoc */\n\nimport Ajv, { type ValidateFunction } from \"ajv\";\nimport type { BaseMessage } from \"./types\";\n\nconst ajv = new Ajv({ removeAdditional: true, allErrors: true });\n\nconst registerSchema = {\n\ttype: \"object\",\n\trequired: [\"type\", \"payload\"],\n\tproperties: {\n\t\ttype: { const: \"register\" },\n\t\tid: { type: \"string\", nullable: true },\n\t\tpayload: {\n\t\t\ttype: \"object\",\n\t\t\trequired: [\"clientName\", \"clientVersion\", \"clientType\"],\n\t\t\tproperties: {\n\t\t\t\tclientName: { type: \"string\", minLength: 1 },\n\t\t\t\tclientVersion: { type: \"string\", minLength: 1 },\n\t\t\t\tclientType: { enum: [\"mobile\", \"web\", \"desktop\", \"other\"] },\n\t\t\t\tlastSeqSeen: { type: \"number\" },\n\t\t\t\tacceptCompression: { type: \"boolean\" },\n\t\t\t},\n\t\t\tadditionalProperties: false,\n\t\t},\n\t},\n\tadditionalProperties: false,\n} as const;\n\nconst simpleTypeSchema = (typeValue: string): ValidateFunction =>\n\tajv.compile({\n\t\ttype: \"object\",\n\t\trequired: [\"type\"],\n\t\tproperties: {\n\t\t\ttype: { const: typeValue },\n\t\t\tid: { type: \"string\", nullable: true },\n\t\t},\n\t\tadditionalProperties: false,\n\t});\n\nconst subscribeSchema = {\n\ttype: \"object\",\n\trequired: [\"type\"],\n\tproperties: {\n\t\ttype: { enum: [\"subscribe\", \"unsubscribe\"] },\n\t\tid: { type: \"string\", nullable: true },\n\t\tpayload: {\n\t\t\ttype: \"object\",\n\t\t\tproperties: {\n\t\t\t\tdeviceIds: { type: \"array\", items: { type: \"string\" } },\n\t\t\t\trooms: { type: \"array\", items: { type: \"string\" } },\n\t\t\t\tcapabilityTypes: { type: \"array\", items: { type: \"string\" } },\n\t\t\t},\n\t\t\tadditionalProperties: false,\n\t\t},\n\t},\n\tadditionalProperties: false,\n} as const;\n\nconst setStateSchema = {\n\ttype: \"object\",\n\trequired: [\"type\", \"payload\"],\n\tproperties: {\n\t\ttype: { const: \"setState\" },\n\t\tid: { type: \"string\", nullable: true },\n\t\tpayload: {\n\t\t\ttype: \"object\",\n\t\t\trequired: [\"deviceId\", \"capability\", \"state\", \"value\"],\n\t\t\tproperties: {\n\t\t\t\tdeviceId: { type: \"string\", minLength: 1 },\n\t\t\t\tcapability: { type: \"string\", minLength: 1 },\n\t\t\t\tstate: { type: \"string\", minLength: 1 },\n\t\t\t\tvalue: {},\n\t\t\t\tack: { type: \"boolean\" },\n\t\t\t},\n\t\t\tadditionalProperties: false,\n\t\t},\n\t},\n\tadditionalProperties: false,\n} as const;\n\nconst validators: Record<string, ValidateFunction> = {\n\tregister: ajv.compile(registerSchema),\n\tgetDevices: simpleTypeSchema(\"getDevices\"),\n\tgetRooms: simpleTypeSchema(\"getRooms\"),\n\tgetSnapshot: simpleTypeSchema(\"getSnapshot\"),\n\thelp: simpleTypeSchema(\"help\"),\n\tsubscribe: ajv.compile(subscribeSchema),\n\tunsubscribe: ajv.compile(subscribeSchema),\n\tsetState: ajv.compile(setStateSchema),\n};\n\nexport function validateIncoming(message: unknown): { ok: boolean; errors?: string[]; parsed?: BaseMessage } {\n\tif (typeof message !== \"object\" || message === null) {\n\t\treturn { ok: false, errors: [\"Message must be an object\"] };\n\t}\n\tconst typed = message as BaseMessage;\n\tif (!typed.type || typeof typed.type !== \"string\") {\n\t\treturn { ok: false, errors: [\"Missing or invalid type\"] };\n\t}\n\tconst validator = validators[typed.type];\n\tif (!validator) {\n\t\t// unknown types handled elsewhere\n\t\treturn { ok: true, parsed: typed };\n\t}\n\tconst valid = validator(typed);\n\tif (!valid) {\n\t\tconst errs = (validator.errors || []).map((e: any) => {\n\t\t\tconst path = e.instancePath || e.dataPath || \"/\";\n\t\t\treturn `${path} ${e.message ?? \"\"}`.trim();\n\t\t});\n\t\treturn { ok: false, errors: errs };\n\t}\n\treturn { ok: true, parsed: typed };\n}\n"],
  "mappings": "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",
  "names": ["Ajv"]
}
