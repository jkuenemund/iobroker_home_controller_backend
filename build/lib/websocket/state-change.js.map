{
  "version": 3,
  "sources": ["../../../src/lib/websocket/state-change.ts"],
  "sourcesContent": ["/* eslint-disable jsdoc/require-param, jsdoc/require-jsdoc */\n\nimport { WebSocket } from \"ws\";\nimport type { BaseMessage, ConnectedClient, StateChangeMessage } from \"./types\";\nimport type { SnapshotService } from \"../services/snapshot-service\";\nimport type { SubscriptionRegistry } from \"./subscriptions\";\nimport { applySubscriptions } from \"./handlers\";\n\nexport interface StateChangeDeps {\n\tadapter: {\n\t\tlog: {\n\t\t\tdebug: (msg: string) => void;\n\t\t\tinfo: (msg: string) => void;\n\t\t\twarn: (msg: string) => void;\n\t\t\terror: (msg: string) => void;\n\t\t};\n\t\tsubscribeForeignStates: (pattern: string) => void;\n\t};\n\tsnapshotService: SnapshotService;\n\tclients: Map<WebSocket, ConnectedClient>;\n\tsend: (ws: WebSocket, message: BaseMessage) => void;\n}\n\nexport class StateChangeManager {\n\tprivate readonly deps: StateChangeDeps;\n\tprivate readonly stateMap: Map<string, Array<{ deviceId: string; capability: string }>> = new Map();\n\tprivate readonly subscriptions: SubscriptionRegistry;\n\tprivate readonly ctxForSubs: {\n\t\tsubscriptions: SubscriptionRegistry;\n\t\tclients: Map<WebSocket, ConnectedClient>;\n\t};\n\n\tconstructor(deps: StateChangeDeps, subscriptions: SubscriptionRegistry) {\n\t\tthis.deps = deps;\n\t\tthis.subscriptions = subscriptions;\n\t\tthis.ctxForSubs = {\n\t\t\tsubscriptions: this.subscriptions,\n\t\t\tclients: this.deps.clients,\n\t\t};\n\t}\n\n\tpublic async subscribeToAllStates(): Promise<void> {\n\t\ttry {\n\t\t\tconst devices = await this.deps.snapshotService.getDevices();\n\n\t\t\tthis.stateMap.clear();\n\t\t\tconst statesToSubscribe = new Set<string>();\n\n\t\t\tfor (const [deviceId, config] of Object.entries(devices)) {\n\t\t\t\tif (config.capabilities) {\n\t\t\t\t\tfor (const cap of config.capabilities) {\n\t\t\t\t\t\tif (cap.state) {\n\t\t\t\t\t\t\tstatesToSubscribe.add(cap.state);\n\t\t\t\t\t\t\tconst existing = this.stateMap.get(cap.state) || [];\n\t\t\t\t\t\t\texisting.push({ deviceId, capability: cap.type });\n\t\t\t\t\t\t\tthis.stateMap.set(cap.state, existing);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tfor (const oid of statesToSubscribe) {\n\t\t\t\tthis.deps.adapter.subscribeForeignStates(oid);\n\t\t\t}\n\n\t\t\tthis.deps.adapter.log.info(`Subscribed to ${statesToSubscribe.size} states for real-time updates`);\n\t\t} catch (error) {\n\t\t\tthis.deps.adapter.log.error(`Failed to subscribe to states: ${(error as Error).message}`);\n\t\t}\n\t}\n\n\tpublic handleStateChange(id: string, state: ioBroker.State): void {\n\t\tconst affected = this.stateMap.get(id);\n\t\tif (affected && affected.length > 0) {\n\t\t\tfor (const item of affected) {\n\t\t\t\tthis.broadcastStateChange(item.deviceId, item.capability, id, state.val, state.ts);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate broadcastStateChange(deviceId: string, capability: string, stateId: string, value: any, ts: number): void {\n\t\tconst message: StateChangeMessage = {\n\t\t\ttype: \"stateChange\",\n\t\t\tid: undefined,\n\t\t\tpayload: {\n\t\t\t\tdeviceId,\n\t\t\t\tcapability,\n\t\t\t\tstate: stateId,\n\t\t\t\tvalue,\n\t\t\t\ttimestamp: new Date(ts).toISOString(),\n\t\t\t},\n\t\t};\n\n\t\tconst deliveries = applySubscriptions(this.ctxForSubs as any, message);\n\t\tfor (const [ws, msg] of deliveries) {\n\t\t\tthis.deps.send(ws, msg);\n\t\t}\n\t}\n}\n\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAMA,sBAAmC;AAiB5B,MAAM,mBAAmB;AAAA,EACd;AAAA,EACA,WAAyE,oBAAI,IAAI;AAAA,EACjF;AAAA,EACA;AAAA,EAKjB,YAAY,MAAuB,eAAqC;AACvE,SAAK,OAAO;AACZ,SAAK,gBAAgB;AACrB,SAAK,aAAa;AAAA,MACjB,eAAe,KAAK;AAAA,MACpB,SAAS,KAAK,KAAK;AAAA,IACpB;AAAA,EACD;AAAA,EAEA,MAAa,uBAAsC;AAClD,QAAI;AACH,YAAM,UAAU,MAAM,KAAK,KAAK,gBAAgB,WAAW;AAE3D,WAAK,SAAS,MAAM;AACpB,YAAM,oBAAoB,oBAAI,IAAY;AAE1C,iBAAW,CAAC,UAAU,MAAM,KAAK,OAAO,QAAQ,OAAO,GAAG;AACzD,YAAI,OAAO,cAAc;AACxB,qBAAW,OAAO,OAAO,cAAc;AACtC,gBAAI,IAAI,OAAO;AACd,gCAAkB,IAAI,IAAI,KAAK;AAC/B,oBAAM,WAAW,KAAK,SAAS,IAAI,IAAI,KAAK,KAAK,CAAC;AAClD,uBAAS,KAAK,EAAE,UAAU,YAAY,IAAI,KAAK,CAAC;AAChD,mBAAK,SAAS,IAAI,IAAI,OAAO,QAAQ;AAAA,YACtC;AAAA,UACD;AAAA,QACD;AAAA,MACD;AAEA,iBAAW,OAAO,mBAAmB;AACpC,aAAK,KAAK,QAAQ,uBAAuB,GAAG;AAAA,MAC7C;AAEA,WAAK,KAAK,QAAQ,IAAI,KAAK,iBAAiB,kBAAkB,IAAI,+BAA+B;AAAA,IAClG,SAAS,OAAO;AACf,WAAK,KAAK,QAAQ,IAAI,MAAM,kCAAmC,MAAgB,OAAO,EAAE;AAAA,IACzF;AAAA,EACD;AAAA,EAEO,kBAAkB,IAAY,OAA6B;AACjE,UAAM,WAAW,KAAK,SAAS,IAAI,EAAE;AACrC,QAAI,YAAY,SAAS,SAAS,GAAG;AACpC,iBAAW,QAAQ,UAAU;AAC5B,aAAK,qBAAqB,KAAK,UAAU,KAAK,YAAY,IAAI,MAAM,KAAK,MAAM,EAAE;AAAA,MAClF;AAAA,IACD;AAAA,EACD;AAAA,EAEQ,qBAAqB,UAAkB,YAAoB,SAAiB,OAAY,IAAkB;AACjH,UAAM,UAA8B;AAAA,MACnC,MAAM;AAAA,MACN,IAAI;AAAA,MACJ,SAAS;AAAA,QACR;AAAA,QACA;AAAA,QACA,OAAO;AAAA,QACP;AAAA,QACA,WAAW,IAAI,KAAK,EAAE,EAAE,YAAY;AAAA,MACrC;AAAA,IACD;AAEA,UAAM,iBAAa,oCAAmB,KAAK,YAAmB,OAAO;AACrE,eAAW,CAAC,IAAI,GAAG,KAAK,YAAY;AACnC,WAAK,KAAK,KAAK,IAAI,GAAG;AAAA,IACvB;AAAA,EACD;AACD;",
  "names": []
}
