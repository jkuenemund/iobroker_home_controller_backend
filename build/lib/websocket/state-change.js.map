{
  "version": 3,
  "sources": ["../../../src/lib/websocket/state-change.ts"],
  "sourcesContent": ["/* eslint-disable jsdoc/require-param, jsdoc/require-jsdoc */\n\nimport { WebSocket } from \"ws\";\nimport type {\n\tBaseMessage,\n\tConnectedClient,\n\tStateChangeMessage,\n\tStateChangeBatchMessage,\n\tThrottleHintMessage,\n} from \"./types\";\nimport type { SnapshotService } from \"../services/snapshot-service\";\nimport type { SubscriptionRegistry } from \"./subscriptions\";\nimport { applySubscriptions } from \"./handlers\";\n\nexport interface StateChangeDeps {\n\tadapter: {\n\t\tlog: {\n\t\t\tdebug: (msg: string) => void;\n\t\t\tinfo: (msg: string) => void;\n\t\t\twarn: (msg: string) => void;\n\t\t\terror: (msg: string) => void;\n\t\t};\n\t\tsubscribeForeignStates: (pattern: string) => void;\n\t};\n\tsnapshotService: SnapshotService;\n\tclients: Map<WebSocket, ConnectedClient>;\n\tsend: (ws: WebSocket, message: BaseMessage) => void;\n}\n\nexport class StateChangeManager {\n\tprivate readonly deps: StateChangeDeps;\n\tprivate readonly stateMap: Map<string, Array<{ deviceId: string; capability: string }>> = new Map();\n\tprivate readonly subscriptions: SubscriptionRegistry;\n\tprivate readonly deviceRooms: Map<string, string> = new Map();\n\tprivate readonly ctxForSubs: {\n\t\tsubscriptions: SubscriptionRegistry;\n\t\tclients: Map<WebSocket, ConnectedClient>;\n\t};\n\tprivate readonly queue: StateChangeMessage[\"payload\"][] = [];\n\tprivate flushTimer: NodeJS.Timeout | null = null;\n\tprivate readonly batchIntervalMs = 200;\n\tprivate eventsThisSecond = 0;\n\tprivate windowStart = Date.now();\n\n\tconstructor(deps: StateChangeDeps, subscriptions: SubscriptionRegistry) {\n\t\tthis.deps = deps;\n\t\tthis.subscriptions = subscriptions;\n\t\tthis.ctxForSubs = {\n\t\t\tsubscriptions: this.subscriptions,\n\t\t\tclients: this.deps.clients,\n\t\t};\n\t}\n\n\tpublic async subscribeToAllStates(): Promise<void> {\n\t\ttry {\n\t\t\tconst devices = await this.deps.snapshotService.getDevices();\n\n\t\t\tthis.stateMap.clear();\n\t\t\tthis.deviceRooms.clear();\n\t\t\tconst statesToSubscribe = new Set<string>();\n\n\t\t\tfor (const [deviceId, config] of Object.entries(devices)) {\n\t\t\t\tif (config.capabilities) {\n\t\t\t\t\tif (config.room) {\n\t\t\t\t\t\tthis.deviceRooms.set(deviceId, config.room);\n\t\t\t\t\t}\n\t\t\t\t\tfor (const cap of config.capabilities) {\n\t\t\t\t\t\tif (cap.state) {\n\t\t\t\t\t\t\tstatesToSubscribe.add(cap.state);\n\t\t\t\t\t\t\tconst existing = this.stateMap.get(cap.state) || [];\n\t\t\t\t\t\t\texisting.push({ deviceId, capability: cap.type });\n\t\t\t\t\t\t\tthis.stateMap.set(cap.state, existing);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tfor (const oid of statesToSubscribe) {\n\t\t\t\tthis.deps.adapter.subscribeForeignStates(oid);\n\t\t\t}\n\n\t\t\tthis.subscriptions.setDeviceRooms(this.deviceRooms);\n\t\t\tthis.deps.adapter.log.info(`Subscribed to ${statesToSubscribe.size} states for real-time updates`);\n\t\t} catch (error) {\n\t\t\tthis.deps.adapter.log.error(`Failed to subscribe to states: ${(error as Error).message}`);\n\t\t}\n\t}\n\n\tpublic handleStateChange(id: string, state: ioBroker.State): void {\n\t\tconst affected = this.stateMap.get(id);\n\t\tif (affected && affected.length > 0) {\n\t\t\tfor (const item of affected) {\n\t\t\t\tthis.enqueueStateChange(item.deviceId, item.capability, id, state.val, state.ts);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate enqueueStateChange(deviceId: string, capability: string, stateId: string, value: any, ts: number): void {\n\t\tthis.countEvent();\n\t\tthis.queue.push({\n\t\t\tdeviceId,\n\t\t\tcapability,\n\t\t\tstate: stateId,\n\t\t\tvalue,\n\t\t\ttimestamp: new Date(ts).toISOString(),\n\t\t});\n\t\tif (!this.flushTimer) {\n\t\t\tthis.flushTimer = setTimeout(() => this.flushQueue(), this.batchIntervalMs);\n\t\t}\n\t}\n\n\tprivate flushQueue(): void {\n\t\tthis.flushTimer = null;\n\t\tif (this.queue.length === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tfor (const ws of this.deps.clients.keys()) {\n\t\t\tconst clientEvents: StateChangeMessage[\"payload\"][] = [];\n\t\t\tfor (const payload of this.queue) {\n\t\t\t\tconst message: StateChangeMessage = { type: \"stateChange\", payload };\n\t\t\t\tif (this.subscriptions.shouldDeliver(ws, message, this.deps.clients)) {\n\t\t\t\t\tclientEvents.push(payload);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (clientEvents.length === 0) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (clientEvents.length === 1) {\n\t\t\t\tconst single: StateChangeMessage = { type: \"stateChange\", payload: clientEvents[0] };\n\t\t\t\tthis.deps.send(ws, single);\n\t\t\t} else {\n\t\t\t\tconst batch: StateChangeBatchMessage = {\n\t\t\t\t\ttype: \"stateChangeBatch\",\n\t\t\t\t\tpayload: { events: clientEvents },\n\t\t\t\t};\n\t\t\t\tthis.deps.send(ws, batch);\n\t\t\t}\n\t\t}\n\n\t\tthis.queue.length = 0;\n\t}\n\n\tprivate countEvent(): void {\n\t\tconst now = Date.now();\n\t\tif (now - this.windowStart >= 1000) {\n\t\t\tthis.windowStart = now;\n\t\t\tthis.eventsThisSecond = 0;\n\t\t}\n\t\tthis.eventsThisSecond += 1;\n\t\tconst limit = this.deps.adapter.config.maxEventsPerSecond ?? 50;\n\t\tif (this.eventsThisSecond > limit) {\n\t\t\tthis.sendThrottleHint();\n\t\t}\n\t}\n\n\tprivate sendThrottleHint(): void {\n\t\tconst hint: ThrottleHintMessage = {\n\t\t\ttype: \"throttleHint\",\n\t\t\tpayload: {\n\t\t\t\treason: \"rate_limit\",\n\t\t\t\tretryAfterMs: this.batchIntervalMs,\n\t\t\t},\n\t\t};\n\t\tfor (const ws of this.deps.clients.keys()) {\n\t\t\tthis.deps.send(ws, hint);\n\t\t}\n\t}\n}\n\n"],
  "mappings": "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",
  "names": []
}
