{
  "version": 3,
  "sources": ["../../../src/lib/websocket/subscriptions.ts"],
  "sourcesContent": ["/* eslint-disable jsdoc/require-param, jsdoc/require-jsdoc */\n\nimport { WebSocket } from \"ws\";\nimport type { ConnectedClient, StateChangeMessage } from \"./types\";\n\nexport interface SubscriptionFilters {\n\tdeviceIds?: string[];\n\trooms?: string[];\n\tcapabilityTypes?: string[];\n}\n\nexport interface SubscriptionRegistryDeps {\n\tdefaultSubscription: \"all\" | \"none\";\n}\n\nexport class SubscriptionRegistry {\n\tprivate readonly deps: SubscriptionRegistryDeps;\n\tprivate readonly filters: Map<WebSocket, SubscriptionFilters> = new Map();\n\tprivate readonly deviceRooms: Map<string, string> = new Map();\n\n\tconstructor(deps: SubscriptionRegistryDeps) {\n\t\tthis.deps = deps;\n\t}\n\n\tpublic setDeviceRooms(map: Map<string, string>): void {\n\t\tthis.deviceRooms.clear();\n\t\tfor (const [k, v] of map.entries()) {\n\t\t\tthis.deviceRooms.set(k, v);\n\t\t}\n\t}\n\n\tpublic setDefault(ws: WebSocket): void {\n\t\tif (this.deps.defaultSubscription === \"all\") {\n\t\t\tthis.filters.set(ws, {});\n\t\t}\n\t}\n\n\tpublic subscribe(ws: WebSocket, filters: SubscriptionFilters): void {\n\t\tthis.filters.set(ws, filters);\n\t}\n\n\tpublic unsubscribe(ws: WebSocket, filters?: SubscriptionFilters): void {\n\t\tif (!filters || Object.keys(filters).length === 0) {\n\t\t\tthis.filters.delete(ws);\n\t\t\treturn;\n\t\t}\n\t\tconst existing = this.filters.get(ws);\n\t\tif (!existing) {\n\t\t\treturn;\n\t\t}\n\t\tthis.filters.set(ws, {\n\t\t\tdeviceIds: this.diff(existing.deviceIds, filters.deviceIds),\n\t\t\trooms: this.diff(existing.rooms, filters.rooms),\n\t\t\tcapabilityTypes: this.diff(existing.capabilityTypes, filters.capabilityTypes),\n\t\t});\n\t}\n\n\tprivate diff(current?: string[], remove?: string[]): string[] | undefined {\n\t\tif (!current) return undefined;\n\t\tif (!remove || remove.length === 0) return current;\n\t\tconst set = new Set(current);\n\t\tfor (const item of remove) {\n\t\t\tset.delete(item);\n\t\t}\n\t\treturn Array.from(set);\n\t}\n\n\tpublic shouldDeliver(ws: WebSocket, event: StateChangeMessage, clients: Map<WebSocket, ConnectedClient>): boolean {\n\t\tconst filters = this.filters.get(ws);\n\t\t// defaultSubscription=none and no filters => deliver nothing\n\t\tif (!filters && this.deps.defaultSubscription === \"none\") {\n\t\t\treturn false;\n\t\t}\n\t\t// no filters or default all\n\t\tif (!filters || Object.keys(filters).length === 0) {\n\t\t\treturn true;\n\t\t}\n\t\tconst { deviceIds, rooms, capabilityTypes } = filters;\n\t\tconst payload = event.payload;\n\t\tif (deviceIds && deviceIds.length > 0 && !deviceIds.includes(payload.deviceId)) {\n\t\t\treturn false;\n\t\t}\n\t\tif (capabilityTypes && capabilityTypes.length > 0 && !capabilityTypes.includes(payload.capability)) {\n\t\t\treturn false;\n\t\t}\n\t\tif (rooms && rooms.length > 0) {\n\t\t\tconst room = this.deviceRooms.get(payload.deviceId);\n\t\t\tif (!room || !rooms.includes(room)) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n\n\tpublic shouldDeliverRoom(ws: WebSocket, roomsPayload: { roomId: string }[]): boolean {\n\t\tconst filters = this.filters.get(ws);\n\t\tif (!filters && this.deps.defaultSubscription === \"none\") {\n\t\t\treturn false;\n\t\t}\n\t\tif (!filters || Object.keys(filters).length === 0) {\n\t\t\treturn true;\n\t\t}\n\t\tconst roomFilter = filters.rooms;\n\t\tif (!roomFilter || roomFilter.length === 0) {\n\t\t\t// no room filter means deliver\n\t\t\treturn true;\n\t\t}\n\t\t// deliver if any room matches\n\t\treturn roomsPayload.some(r => roomFilter.includes(r.roomId));\n\t}\n\n\tpublic remove(ws: WebSocket): void {\n\t\tthis.filters.delete(ws);\n\t}\n}\n\n"],
  "mappings": "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",
  "names": []
}
